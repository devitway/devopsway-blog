{{/* –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω—ã –ª–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ */}}
{{- $needsDiagrams := false -}}
{{- if or .Params.diagrams 
          (findRE `{{<\s*diagram\s` .RawContent)
          (findRE `{{<\s*mermaid-enhanced\s` .RawContent)
          (findRE `{{<\s*risk-table\s` .RawContent)
          (findRE `\!\[.*\]\(.*(?:diagram|architecture|schema).*\)` .RawContent) -}}
  {{- $needsDiagrams = true -}}
{{- end -}}

{{- if $needsDiagrams -}}
<!-- –î–∏–∞–≥—Ä–∞–º–º—ã: CSS —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π -->
{{- $diagramCSS := resources.Get "css/extended/diagrams.css" | minify | fingerprint -}}
<link rel="preload" href="{{ $diagramCSS.RelPermalink }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ $diagramCSS.RelPermalink }}"></noscript>

{{/* –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ Mermaid */}}
{{- if or .Params.mermaid 
          (findRE `{{<\s*mermaid-enhanced\s` .RawContent)
          (findRE `class="mermaid"` .RawContent) -}}
<!-- Mermaid: –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" as="script">
{{- end -}}

<!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π inline CSS –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º -->
<style>
/* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º layout shift */
.diagram-wrapper {
  min-height: 200px;
  background: var(--skeleton-bg, #f0f0f0);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.diagram-wrapper::before {
  content: "üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã...";
  color: var(--text-secondary, #666);
  font-size: 0.9rem;
}

.diagram-wrapper.loaded::before {
  display: none;
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
[data-theme="dark"] .diagram-wrapper {
  background: #2a2a2a;
}
</style>
{{- end -}}