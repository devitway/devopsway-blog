{{/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–º—ã */}}

<script>
// –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
  
  // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è —è–∫–æ—Ä–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
  
  // Lazy loading –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    });
    
    document.querySelectorAll('img[data-src]').forEach(img => {
      imageObserver.observe(img);
    });
  }
  
  // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞
  document.querySelectorAll('pre code').forEach((block) => {
    // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç —è–∑—ã–∫–∞ –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
    const language = block.className.match(/language-(\w+)/);
    if (language) {
      const highlight = block.closest('.highlight');
      if (highlight) {
        highlight.setAttribute('data-lang', language[1]);
      }
    }
  });
  
  console.log('üöÄ DevOps Way Blog - –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
});

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
if (typeof gtag !== 'undefined') {
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —á—Ç–µ–Ω–∏—è
  let startTime = Date.now();
  let maxScroll = 0;
  
  window.addEventListener('beforeunload', () => {
    const timeSpent = Math.round((Date.now() - startTime) / 1000);
    if (timeSpent > 10) { // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ–≤–µ–ª –±–æ–ª—å—à–µ 10 —Å–µ–∫—É–Ω–¥
      gtag('event', 'page_view_time', {
        event_category: 'engagement',
        event_label: window.location.pathname,
        value: timeSpent
      });
    }
  });
  
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
  window.addEventListener('scroll', () => {
    const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
    if (scrollPercent > maxScroll) {
      maxScroll = scrollPercent;
      if (maxScroll % 25 === 0 && maxScroll > 0) { // –ö–∞–∂–¥—ã–µ 25%
        gtag('event', 'scroll_depth', {
          event_category: 'engagement',
          event_label: `${maxScroll}%`,
          value: maxScroll
        });
      }
    }
  });
}
</script>

{{/* Service Worker –¥–ª—è PWA (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */}}
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(function(registration) {
    console.log('SW registered: ', registration);
  }).catch(function(registrationError) {
    console.log('SW registration failed: ', registrationError);
  });
}
</script>
{{/* –î–∏–∞–≥—Ä–∞–º–º—ã: —É—Å–ª–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ JavaScript */}}
{{- $needsDiagrams := false -}}
{{- if or .Params.diagrams 
          (findRE `{{<\s*diagram\s` .RawContent)
          (findRE `{{<\s*mermaid-enhanced\s` .RawContent)
          (findRE `{{<\s*risk-table\s` .RawContent) -}}
  {{- $needsDiagrams = true -}}
{{- end -}}

{{- if $needsDiagrams -}}
{{- $diagramJS := resources.Get "js/diagram-system.js" -}}
{{- if $diagramJS -}}
{{- $diagramJS = $diagramJS | minify | fingerprint -}}

{{/* Mermaid –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω */}}
{{- if or .Params.mermaid (findRE `mermaid-enhanced` .RawContent) -}}
<script>
// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Mermaid
(function() {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
  script.async = true;
  script.onload = function() {
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({
        startOnLoad: false,
        theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default',
        securityLevel: 'loose',
        fontSize: 14
      });
      
      document.querySelectorAll('.mermaid').forEach(el => {
        if (!el.dataset.processed) {
          mermaid.init(undefined, el);
        }
      });
    }
  };
  script.onerror = function() {
    console.warn('Mermaid –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—É–¥–∞–ª–∞—Å—å');
  };
  document.head.appendChild(script);
})();
</script>
{{- end -}}

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –¥–∏–∞–≥—Ä–∞–º–º -->
<script defer src="{{ $diagramJS.RelPermalink }}"></script>

<script>
// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
document.addEventListener('DOMContentLoaded', function() {
  const criticalDiagrams = document.querySelectorAll('img[src*="architecture"], img[src*="diagram"]');
  criticalDiagrams.forEach((img, index) => {
    if (index < 2) {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.href = img.src;
      link.as = 'image';
      document.head.appendChild(link);
    }
  });
});
</script>
{{- end -}}
{{- end -}}
