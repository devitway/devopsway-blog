{{/* CTA - подписка на Telegram (только на страницах постов) */}}
{{ if and .IsPage (eq .Section "posts") }}
<div class="post-cta" style="margin:2rem 0;padding:1.5rem;background:var(--code-bg);border:1px solid var(--border);border-radius:8px;text-align:center;">
  <p style="margin:0 0 1rem;font-size:1.1rem;"><strong>Понравился материал?</strong></p>
  <p style="margin:0 0 1rem;color:var(--secondary);">Подписывайтесь на Telegram-канал — новые гайды, обновления и DevOps практики</p>
  <a href="https://t.me/devitway" target="_blank" rel="noopener"
     style="display:inline-block;padding:0.75rem 1.5rem;background:#2563eb;color:#fff;text-decoration:none;border-radius:6px;font-weight:500;">
    Подписаться на канал
  </a>
</div>
{{ end }}

<script>
// Плавная прокрутка для якорных ссылок
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
    anchor.addEventListener('click', function(e) {
      e.preventDefault();
      var target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });

  // Lazy loading для изображений
  if ('IntersectionObserver' in window) {
    var imageObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.classList.remove('lazy');
          }
          imageObserver.unobserve(img);
        }
      });
    });
    document.querySelectorAll('img[data-src]').forEach(function(img) {
      imageObserver.observe(img);
    });
  }

  // Атрибут языка для блоков кода
  document.querySelectorAll('pre code').forEach(function(block) {
    var match = block.className.match(/language-(\w+)/);
    if (match) {
      var highlight = block.closest('.highlight');
      if (highlight) highlight.setAttribute('data-lang', match[1]);
    }
  });
});

// Аналитика времени чтения и скролла
if (typeof gtag !== 'undefined') {
  var startTime = Date.now();
  var maxScroll = 0;

  window.addEventListener('beforeunload', function() {
    var timeSpent = Math.round((Date.now() - startTime) / 1000);
    if (timeSpent > 10) {
      gtag('event', 'page_view_time', {
        event_category: 'engagement',
        event_label: window.location.pathname,
        value: timeSpent
      });
    }
  });

  window.addEventListener('scroll', function() {
    var scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
    if (scrollPercent > maxScroll) {
      maxScroll = scrollPercent;
      if (maxScroll % 25 === 0 && maxScroll > 0) {
        gtag('event', 'scroll_depth', {
          event_category: 'engagement',
          event_label: maxScroll + '%',
          value: maxScroll
        });
      }
    }
  });
}
</script>

{{/* Service Worker для PWA */}}
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(function() {});
}
</script>
